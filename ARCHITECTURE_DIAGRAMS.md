# Architecture Diagram: Semantic Kernel Planner Integration

## System Overview

```
??????????????????????????????????????????????????????????????????
?             Discovery Service   ?
?                   (Port 5000)        ?
?  - Registers agent capabilities           ?
?  - Resolves skills to endpoints          ?
??????????????????????????????????????????????????????????????????
     ?
     ?????????????????????????????????????????????????
     ? ?               ? ?
???????????    ????????????    ????????????  ????????????
? Agent2  ?    ? Agent3   ?  ? Agent4 ?  ? Agent1   ?
?(Reverse)?    ?(Uppercase)?    ?  (News)  ?  ? (Client) ?
???????????  ????????????    ????????????  ????????????
     ?               ?        ?         ?
     ?????????????????????????????????????????????????
    ?
     ???????????????????????????
   ?  Semantic Kernel Core   ?
        ?  - TextProcessingPlugin ?
   ?  - AgentRouter     ?
 ???????????????????????????
```

---

## Plugin Architecture

```
???????????????????????????????????????????????????????????
?         TextProcessingPlugin       ?
???????????????????????????????????????????????????????????
?                ?
?  [KernelFunction("reverse_text")]    ?
?  public string Reverse(string input)     ?
?               ?
?  [KernelFunction("uppercase_text")]      ?
?  public string Uppercase(string input)      ?
? ?
?  [KernelFunction("search_news")]       ?
?  public async Task<string> SearchNews(...)    ?
?      ?
???????????????????????????????????????????????????????????
      ?
  ? Imported by
      ?
?????????????????????????????????????????????????????????
?    Semantic Kernel          ?
?  kernel.ImportPluginFromType<TextProcessingPlugin>()   ?
?  - Discovers all [KernelFunction] methods   ?
?  - Makes them invocable        ?
???????????????????????????????????????????????????????????
```

---

## Request Routing Flow

```
????????????????????????????????????????????????????????
?1. User Request (Natural Language)            ?
?  "Can you find me news about AI?"    ?
????????????????????????????????????????????????????????
   ?
      ?
????????????????????????????????????????????????????????
?  2. Agent1 (Client API)         ?
?  - Receives request         ?
?  - Queries discovery service           ?
?  - Routes to appropriate agent  ?
????????????????????????????????????????????????????????
 ?
    ?
????????????????????????????????????????????????????????
?  3. Agent (e.g., Agent4)         ?
?  - Receives A2A message       ?
?  - Extracts text from message ?
????????????????????????????????????????????????????????
           ?
       ?
????????????????????????????????????????????????????????
?  4. AgentRouter             ?
???????????????????????????????????????????????     ?
?  ? DetermineIntentAsync()      ?     ?
?  ? - Uses AI to analyze request      ?     ?
?  ? - Determines function: "search_news" ?     ?
?  ? - Extracts parameter: "AI"        ?     ?
?  ??????????????????????????????????????????????     ?
????????????????????????????????????????????????????????
             ?
    ?
????????????????????????????????????????????????????????
?  5. Semantic Kernel      ?
?  - Looks up "search_news" in TextProcessingPlugin    ?
?  - Invokes function with parameters      ?
????????????????????????????????????????????????????????
             ?
     ?
????????????????????????????????????????????????????????
?  6. TextProcessingPlugin.SearchNews()          ?
?  - Calls ChatGPT API        ?
?  - Generates news summary        ?
????????????????????????????????????????????????????????
  ?
       ?
????????????????????????????????????????????????????????
?  7. Agent Post-Processing          ?
?  - For news: Creates file        ?
?  - Wraps result in A2A message   ?
????????????????????????????????????????????????????????
             ?
        ?
????????????????????????????????????????????????????????
?  8. Response to Agent1        ?
?  - Agent1 receives result         ?
?  - Returns to user via HTTP          ?
????????????????????????????????????????????????????????
```

---

## AgentRouter Decision Tree

```
???????????????????????????????????????
?   User Request Received       ?
???????????????????????????????????????
               ?
   ?
      ??????????????????????
   ?  Try AI Routing    ?
      ?(Primary Method)  ?
      ??????????????????????
               ?
    ?? Success ???
               ?   ?
       ?? Failure   ?
    ?  ?
?   ??????????????????????
           ?   ? Parse AI Response  ?
               ?   ? Extract:           ?
               ?   ? - Function name    ?
               ?   ? - Parameters       ?
               ?   ??????????????????????
 ?            ?
       ?    ?
   ???????????????????????
      ?  Fallback Routing  ??
      ?  (Heuristics)      ??
   ???????????????????????
     ?            ?
     ?? Contains "reverse" ? reverse_text
  ?? Contains "upper"   ? uppercase_text
 ?? Contains "news"    ? search_news
     ?   ?
        ????????????????????????????
              ?
             ?
         ?????????????????????????
 ?  Execute Function ?
              ?  via Semantic Kernel  ?
 ?????????????????????????
      ?
        ?
     ?????????????????????????
         ?  Return Result      ?
    ?????????????????????????
```

---

## Message Flow (A2A Protocol)

```
Agent1         Transport              Agent4
  ?  ?   ?
  ?  1. Build AgentMessage ?              ?
  ?  {       ?      ?
  ?    "from": "Agent1"    ?       ?
  ?    "to": "Agent4" ?                  ?
  ?    "text": "news: AI"  ??
  ?  }          ?             ?
  ??????????????????????????          ?
  ?   ?       ?
  ?    ?  2. Serialize JSON   ?
  ?         ?     & Send           ?
  ?        ????????????????????????
  ?    ?     ?
  ?    ??  3. Deserialize
  ?         ?          ?  4. Parse request
  ?   ?    ?  5. Route via AgentRouter
  ?         ?      ?  6. Execute function
  ?        ?            ?  7. Create file (if news)
  ?         ?     ?  8. Build response
?               ?    ?
  ?      ?  9. Send Response    ?
  ?  ????????????????????????
  ?                 ?    ?
  ?  10. Receive & Parse   ?    ?
  ??????????????????????????          ?
  ?             ?              ?
  ?11. Return to User    ?      ?
  ?     ?      ?
```

---

## Plugin Discovery Process

```
??????????????????????????????????????????????????????
?  Agent Startup        ?
??????????????????????????????????????????????????????
        ?
             ?
??????????????????????????????????????????????????????
?  kernel.ImportPluginFromType<TextProcessingPlugin>()?
??????????????????????????????????????????????????????
     ?
        ?
??????????????????????????????????????????????????????
?  Semantic Kernel Scans Class  ?
?  - Finds all methods with [KernelFunction]         ?
?  - Reads [Description] attributes          ?
?  - Builds function metadata   ?
??????????????????????????????????????????????????????
             ?
             ?
??????????????????????????????????????????????????????
?  Plugin Registered as "TextProcessing"       ?
?  ????????????????????????????????????????????     ?
?  ?  Function: reverse_text    ?     ?
?  ?  Description: "Reverses the input text"  ?   ?
?  ?  Parameters: [string input]     ?     ?
?  ????????????????????????????????????????????     ?
?  ????????????????????????????????????????????     ?
?  ?  Function: uppercase_text        ?     ?
?  ?  Description: "Converts to uppercase"    ?     ?
?  ?  Parameters: [string input]?     ?
?  ????????????????????????????????????????????     ?
?  ????????????????????????????????????????????     ?
?  ?  Function: search_news    ?     ?
?  ?  Description: "Searches for news..."     ?     ?
?  ?  Parameters: [string topic, Kernel]      ?   ?
?  ????????????????????????????????????????????     ?
??????????????????????????????????????????????????????
        ?
         ?
??????????????????????????????????????????????????????
?AgentRouter Created          ?
?  - Has access to all plugin functions  ?
?  - Can invoke them dynamically    ?
??????????????????????????????????????????????????????
```

---

## Comparison: Before vs After

### Before (Hardcoded)
```
Request: "reverse: hello"
   ?
?
if (text.StartsWith("reverse:"))
   ?
   ?
input = text.Substring(8).Trim()
   ?
   ?
func = TextProcessingFunction.GetFunctionByType("REVERSE")
?
   ?
result = await kernel.InvokeAsync(func, ...)
```

### After (AI-Powered)
```
Request: "Can you reverse this: hello"
        ?
           ?
        router.RouteAndExecuteAsync(text)
         ?
  ?
     ????????????????????????????????
  ? AI analyzes: "User wants to ?
     ? reverse text, parameter is  ?
     ? 'hello'"          ?
     ????????????????????????????????
    ?
          ?
     kernel.Plugins["TextProcessing"]["reverse_text"]
         ?
      ?
        Execute function
```

---

## Extension Points

```
???????????????????????????????????????????????????????
?         Adding New Capability          ?
???????????????????????????????????????????????????????
       ?
 ?
???????????????????????????????????????????????????????
?  1. Add Function to TextProcessingPlugin      ?
?  ???????????????????????????????????????????       ?
?  ? [KernelFunction("new_function")]      ?  ?
?  ? [Description("Does something cool")]    ?       ?
?  ? public string NewFunction(string input) ?       ?
?  ? { ... }     ?       ?
?  ???????????????????????????????????????????       ?
???????????????????????????????????????????????????????
      ?
  ?
???????????????????????????????????????????????????????
?  2. (Optional) Create Capability Card         ?
?  new_function.card.json          ?
???????????????????????????????????????????????????????
     ?
             ?
???????????????????????????????????????????????????????
?  3. DONE! AgentRouter automatically:          ?
?  - Discovers new function     ?
?  - Routes requests to it         ?
?  - Handles natural language             ?
???????????????????????????????????????????????????????
```

---

## Key Components

| Component | Location | Purpose |
|-----------|----------|---------|
| **TextProcessingPlugin** | Core/SemanticKernel/ | Contains all functions |
| **AgentRouter** | Core/SemanticKernel/ | Intelligent routing |
| **Agent2/3/4** | Agent projects | Process requests |
| **Agent1** | Client project | Entry point |
| **Discovery Service** | Discovery.Service/ | Agent registry |

---

**Architecture Version:** 2.0.0  
**Last Updated:** January 2025  
**Status:** ? Production Ready
